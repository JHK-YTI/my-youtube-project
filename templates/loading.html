{% extends 'layout.html' %}

{% block title %}AI ë¶„ì„ ê²°ê³¼{% endblock %}

{% block head %}
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="loading-view" class="flex flex-col justify-center items-center h-screen {% if is_restored %}hidden{% endif %}">
        <div class="spinner"></div>
        <p id="status-message" class="mt-6 text-lg text-gray-700 font-semibold">ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...</p>
        <p id="error-message" class="mt-4 text-red-600 font-bold"></p>
    </div>

    <div id="dashboard-view" class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 {% if not is_restored %}hidden opacity-0{% endif %} transition-opacity duration-500">
        
        <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸš€ ë‹¤ë¥¸ ì˜ìƒ ë¶„ì„í•˜ê¸°</h3>
            <form method="POST" action="/extract_script" class="flex">
                <input type="text" name="youtube_link" class="w-full px-4 py-3 text-gray-700 bg-gray-100 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ìƒˆë¡œìš´ ìœ íŠœë¸Œ URLì„ ì…ë ¥í•˜ì—¬ ë°”ë¡œ ë¶„ì„í•˜ì„¸ìš”" required>
                <button type="submit" class="flex-shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 py-3 rounded-r-lg transition-colors">
                    <i class="fas fa-search mr-2"></i>ìƒˆë¡œ ë¶„ì„
                </button>
            </form>
        </section>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            <div class="flex flex-col space-y-8 h-full">
                <div class="bg-white p-6 rounded-xl shadow-lg flex-shrink-0">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 border-b pb-3 mb-4"><i class="fas fa-video text-indigo-500"></i>ì˜ìƒ ì •ë³´</h3>
                    <div class="w-full mb-4">
                       <iframe class="w-full aspect-video rounded-lg" id="video-player-iframe" src="" allow="accelerometer; autoplay; clipboard-write; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <div class="space-y-2 text-base">
                        <p><strong><i class="fas fa-heading w-5 text-center mr-1 text-gray-500"></i>ì œëª©:</strong> <span id="video-title"></span></p>
                        <p><strong><i class="fas fa-user-edit w-5 text-center mr-1 text-gray-500"></i>ì—…ë¡œë”:</strong> <span id="video-uploader"></span></p>
                        <p><strong><i class="fas fa-eye w-5 text-center mr-1 text-gray-500"></i>ì¡°íšŒìˆ˜:</strong> <span id="video-views"></span></p>
                        <p><strong><i class="fas fa-thumbs-up w-5 text-center mr-1 text-gray-500"></i>ì¢‹ì•„ìš”:</strong> <span id="video-likes"></span></p>
                        <p><strong><i class="fas fa-comments w-5 text-center mr-1 text-gray-500"></i>ëŒ“ê¸€:</strong> <span id="video-comments"></span></p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col flex-grow">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 border-b pb-3 mb-4 flex-shrink-0"><i class="fas fa-file-alt text-indigo-500"></i>ì›ë³¸ ëŒ€ë³¸</h3>
                    <div class="relative flex-grow min-h-[400px]">
                        <textarea id="original-script-textarea" class="absolute inset-0 w-full h-full bg-gray-50 border border-gray-200 rounded-lg p-4 resize-none text-base leading-relaxed"></textarea>
                    </div>
                    <div class="flex gap-4 mt-4 flex-shrink-0">
                         <button type="button" id="copy-original-btn" class="w-full py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition"><i class="fas fa-copy mr-2"></i>ë³µì‚¬</button>
                         <button type="button" id="download-original-btn" class="w-full py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition"><i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>
            <div class="flex flex-col space-y-8 h-full">
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col flex-grow">
                     <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 border-b pb-3 mb-4 flex-shrink-0"><i class="fas fa-robot text-indigo-500"></i>AI ìë™ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                     <div class="relative flex-grow min-h-[400px]">
                        <div id="analysis-container" class="absolute inset-0 w-full h-full overflow-y-auto bg-gray-50 p-4 rounded-lg prose max-w-none">
                            </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 border-b pb-3 mb-4"><i class="fas fa-comment-dots text-indigo-500"></i>ë² ìŠ¤íŠ¸ ëŒ“ê¸€ ë¶„ì„</h3>
                    <div id="best-comments-container" class="space-y-3 max-h-48 overflow-y-auto pr-2"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                     <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 border-b pb-3 mb-4"><i class="fas fa-brain text-indigo-500"></i>V12 ìµœì¢… ì—”ì§„ ê°ìƒ‰</h3>
                    <form id="v12-rewrite-form" method="POST" action="{{ url_for('v12_rewrite') }}">
                        <input type="hidden" name="original_script" id="v12-original-script">
                        <input type="hidden" name="title" id="v12-title">
                        <input type="hidden" name="original_task_id" value="{{ task_id }}">
                        
                        <div class="mb-4">
                            <label for="v12-category-select" class="block mb-2 text-sm font-medium text-gray-900">ì½˜í…ì¸  íƒ€ì… ì„ íƒ</label>
                            <select id="v12-category-select" name="category" class="w-full px-3 py-2 text-gray-800 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="ssultoon">ì°íˆ° ê°ìƒ‰ (ì‚¬ê±´ ì¬ì°½ì¡°)</option>
                                <option value="community">ì»¤ë®¤ë‹ˆí‹° ê¸€ ê°ìƒ‰ (ë‚´ìš© ìœ ì§€)</option>
                                <option value="top_n">Top N ë¦¬ìŠ¤íŠ¸</option>
                                <option value="knowledge">ì§€ì‹/ì •ë³´ ì „ë‹¬</option>
                                <option value="review">ë¦¬ë·° (ì œí’ˆ/ì„œë¹„ìŠ¤)</option>
                            </select>
                        </div>
                        <button type="submit" id="v12-rewrite-button" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 bg-indigo-600 hover:bg-indigo-700">
                            <i class="fas fa-rocket mr-2"></i>V12 ì—”ì§„ìœ¼ë¡œ ê°ìƒ‰í•˜ê¸°
                        </button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-teal-500">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 border-b pb-3 mb-4"><i class="fas fa-shield-alt text-teal-500"></i>V13 ì•ˆì „ ê°ìƒ‰ ì—”ì§„ (ì €ì‘ê¶Œ íšŒí”¼)</h3>
                   <form id="v13-rewrite-form" method="POST" action="{{ url_for('v13_rewrite') }}">
                       <input type="hidden" name="original_script" id="v13-original-script">
                       <input type="hidden" name="title" id="v13-title">
                       <input type="hidden" name="original_task_id" value="{{ task_id }}">
                       
                       <div class="mb-4">
                           <label for="v13-category-select" class="block mb-2 text-sm font-medium text-gray-900">ì½˜í…ì¸  íƒ€ì… ì„ íƒ</label>
                           <select id="v13-category-select" name="category" class="w-full px-3 py-2 text-gray-800 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                               <option value="ssultoon">ì°íˆ° (ì™„ì „ ì¬ì°½ì‘)</option>
                               <option value="community">ì»¤ë®¤ë‹ˆí‹° (ì™„ì „ ì¬ì°½ì‘)</option>
                               <option value="knowledge">ì§€ì‹/ì •ë³´ (ì™„ì „ ì¬ì°½ì‘)</option>
                               <option value="top_n">Top N ë¦¬ìŠ¤íŠ¸ (ì™„ì „ ì¬ì°½ì‘)</option>
                               <option value="review">ë¦¬ë·° (ì™„ì „ ì¬ì°½ì‘)</option>
                           </select>
                       </div>
                       <button type="submit" id="v13-rewrite-button" class="w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 bg-teal-600 hover:bg-teal-700">
                           <i class="fas fa-feather-alt mr-2"></i>V13 ì—”ì§„ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ê°ìƒ‰í•˜ê¸°
                       </button>
                   </form>
                   </div>
            </div>
        </div>
        
        <div class="mt-12 text-center">
            <button onclick="window.location.href='/'" class="py-3 px-8 bg-gray-800 hover:bg-black text-white font-bold rounded-lg transition">
                <i class="fas fa-home mr-2"></i>ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const task_id = "{{ task_id | default('') }}";
        const is_restored = {{ is_restored | default('false') | tojson }};
        const result_view = "{{ result_view | default('analysis_result') }}";
        const task_type = "{{ task_type | default('celery') }}";
        let initialData = {};

        {% if is_restored %}
        initialData = {{ initial_data_json | safe }};
        {% endif %}
        
        function populateDashboard(data) {
            const dashboard = document.getElementById('dashboard-view');
            if (dashboard.classList.contains('hidden')) {
                document.getElementById('loading-view').classList.add('hidden');
                dashboard.classList.remove('hidden');
                setTimeout(() => { dashboard.style.opacity = 1; }, 50);
            }

            if (data.video_id && !data.video_id.startsWith('user_upload_')) {
                document.getElementById('video-player-iframe').src = `https://www.youtube-nocookie.com/embed/${data.video_id}`;
            } else {
                document.getElementById('video-player-iframe').parentElement.innerHTML = '<div class="w-full aspect-video rounded-lg bg-gray-200 flex items-center justify-center"><p class="text-gray-500">ì‚¬ìš©ì ì—…ë¡œë“œ ëŒ€ë³¸ì…ë‹ˆë‹¤.</p></div>';
            }
            document.getElementById('video-title').textContent = data.title || 'ì œëª© ì—†ìŒ';
            document.getElementById('video-uploader').textContent = data.uploader || 'ì—…ë¡œë” ì •ë³´ ì—†ìŒ';
            document.getElementById('video-views').textContent = data.view_count ? Number(data.view_count).toLocaleString() : 'ì •ë³´ ì—†ìŒ';
            document.getElementById('video-likes').textContent = data.like_count ? Number(data.like_count).toLocaleString() : 'ì •ë³´ ì—†ìŒ';
            document.getElementById('video-comments').textContent = data.comment_count ? Number(data.comment_count).toLocaleString() : 'ì •ë³´ ì—†ìŒ';
            
            const originalScriptText = data.original_script || '';
            document.getElementById('original-script-textarea').value = originalScriptText;
            
            // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ [í•µì‹¬ ìˆ˜ì • ë¶€ë¶„] â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
            // ê¸°ì¡´ì˜ ë³µì¡í•˜ê³  ë¶ˆì•ˆì •í•œ 'ìˆ˜ë¦¬' ì½”ë“œë¥¼ ë²„ë¦¬ê³ ,
            // AIê°€ ë³´ë‚´ì¤€ ê¹¨ë—í•œ ë°ì´í„°ë¥¼ ê°„ë‹¨í•˜ê²Œ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ì•ˆì •ì ì¸ ì½”ë“œë¡œ êµì²´í•©ë‹ˆë‹¤.
            const analysisContainer = document.getElementById('analysis-container');
            const rawAnalysis = data.analysis_summary || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ|||ë¶„ì„ ê²°ê³¼ ì—†ìŒ';
            
            // 1. AIê°€ ì•½ì†í•œ êµ¬ë¶„ ê¸°í˜¸ '|||'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ë‹µì„ ë‘ ë¶€ë¶„ìœ¼ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤.
            const parts = rawAnalysis.split('|||');
            const strengths = parts[0] ? parts[0].trim() : 'í•µì‹¬ ì¸ê¸° ìš”ì¸ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            const improvements = parts[1] ? parts[1].trim() : 'ê°œì„  ì•„ì´ë””ì–´ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';

            // 2. ê° ë¶€ë¶„ì„ ì •í•´ì§„ HTML í˜•ì‹ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
            //    - replace(/\n/g, '<br>')ë¥¼ í†µí•´ ì¤„ë°”ê¿ˆì„ í™”ë©´ì— ì˜¬ë°”ë¥´ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.
            const strengthsHtml = `<h4 class="text-xl font-bold text-gray-800 mt-6 mb-3 border-b pb-2">ğŸ“ˆ ì´ ì˜ìƒì˜ í•µì‹¬ ì¸ê¸° ìš”ì¸</h4><p>${strengths.replace(/\n/g, '<br>')}</p>`;
            const improvementsHtml = `<h4 class="text-xl font-bold text-gray-800 mt-6 mb-3 border-b pb-2">ğŸ’¡ 2ë°°ì˜ ì¡°íšŒìˆ˜ë¥¼ ë¶€ë¥´ëŠ” ê°œì„  ì•„ì´ë””ì–´</h4><p>${improvements.replace(/\n/g, '<br>')}</p>`;

            // 3. ë‘ ê°œì˜ ì•ˆì „í•œ HTML ì¡°ê°ì„ í•©ì³ì„œ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
            analysisContainer.innerHTML = strengthsHtml + improvementsHtml;
            // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
            
            if (data.top_comments) renderComments(data.top_comments);

            const v12ScriptInput = document.getElementById('v12-original-script');
            const v12TitleInput = document.getElementById('v12-title');
            if (v12ScriptInput) v12ScriptInput.value = originalScriptText;
            if (v12TitleInput) v12TitleInput.value = data.title || 'ì œëª© ì—†ìŒ';
            
            const v13ScriptInput = document.getElementById('v13-original-script');
            const v13TitleInput = document.getElementById('v13-title');
            if (v13ScriptInput) v13ScriptInput.value = originalScriptText;
            if (v13TitleInput) v13TitleInput.value = data.title || 'ì œëª© ì—†ìŒ';
        }

        function renderComments(comments) {
            const container = document.getElementById('best-comments-container');
            container.innerHTML = '';
            if (!comments || comments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">í‘œì‹œí•  ë² ìŠ¤íŠ¸ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                if (comment.error) {
                    commentDiv.className = 'bg-yellow-50 p-3 rounded-lg text-yellow-700';
                    commentDiv.textContent = `â“˜ ${comment.error}`;
                } else {
                    commentDiv.className = 'bg-gray-100 p-3 rounded-lg';
                    commentDiv.innerHTML = `<p class="font-semibold text-gray-800 text-sm"><i class="fas fa-user-circle mr-1"></i> ${comment.author || 'ìµëª…'}</p><p class="text-gray-700 mt-1">${comment.text}</p><p class="text-xs text-gray-500 text-right mt-1.5">ğŸ‘ ${comment.like_count ? Number(comment.like_count).toLocaleString() : 0}</p>`;
                }
                container.appendChild(commentDiv);
            });
        }
        
        function checkTaskStatus(taskId) {
            fetch(`/task_status/${taskId}?result_view=${result_view}&task_type=${task_type}`)
                .then(response => response.json())
                .then(data => {
                    const statusMessageEl = document.getElementById('status-message');
                    const errorMessageEl = document.getElementById('error-message');

                    if (data.state === 'PENDING' || data.state === 'PROGRESS') {
                        statusMessageEl.textContent = data.status || 'ì‘ì—…ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...';
                        setTimeout(() => checkTaskStatus(taskId), 2000); 
                    } else if (data.state === 'SUCCESS') {
                        statusMessageEl.textContent = 'ë¶„ì„ ì™„ë£Œ! ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                        window.location.href = data.result_url;
                    } else if (data.state === 'FAILURE') {
                        statusMessageEl.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
                        errorMessageEl.textContent = data.status || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    }
                })
                .catch(err => {
                    const statusMessageEl = document.getElementById('status-message');
                    const errorMessageEl = document.getElementById('error-message');
                    statusMessageEl.textContent = 'ì—°ê²° ì˜¤ë¥˜';
                    errorMessageEl.textContent = 'ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    console.error('Polling error:', err);
                });
        }

        if (is_restored) {
            populateDashboard(initialData);
        } else if (task_id) {
            checkTaskStatus(task_id);
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('copy-original-btn')?.addEventListener('click', () => navigator.clipboard.writeText(document.getElementById('original-script-textarea').value).then(() => alert('ì›ë³¸ ëŒ€ë³¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.')));
            document.getElementById('download-original-btn')?.addEventListener('click', () => {
                const text = document.getElementById('original-script-textarea').value;
                const title = document.getElementById('video-title').textContent || 'original_script';
                const blob = new Blob([text], { type: 'text/plain; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            const v12Form = document.getElementById('v12-rewrite-form');
            if(v12Form) {
                v12Form.addEventListener('submit', function() {
                    const button = document.getElementById('v12-rewrite-button');
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>V12 ì—”ì§„ ê°€ë™ ì¤‘...';
                    
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-rocket mr-2"></i>V12 ì—”ì§„ìœ¼ë¡œ ê°ìƒ‰í•˜ê¸°';
                    }, 5000); 
                });
            }

            const v13Form = document.getElementById('v13-rewrite-form');
            if(v13Form) {
                v13Form.addEventListener('submit', function() {
                    const button = document.getElementById('v13-rewrite-button');
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>V13 ì—”ì§„ ê°€ë™ ì¤‘...';
                    
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-feather-alt mr-2"></i>V13 ì—”ì§„ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ê°ìƒ‰í•˜ê¸°';
                    }, 5000); 
                });
            }
        });
    </script>
{% endblock %}