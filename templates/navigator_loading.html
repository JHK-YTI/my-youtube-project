<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI 기획안 생성 중...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="flex flex-col justify-center items-center h-screen">
        <div class="spinner"></div>
        <p id="status-message" class="mt-6 text-lg text-gray-700 font-semibold">[V2] AI가 입력하신 아이디어를 바탕으로 기획안을 생성 중입니다...</p>
        <p id="error-message" class="mt-4 text-red-600 font-bold"></p>
    </div>

    <script>
        const task_id = "{{ task_id }}";

        function checkTaskStatus(taskId) {
            fetch(`/navigator_task_status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    const statusMessageEl = document.getElementById('status-message');
                    const errorMessageEl = document.getElementById('error-message');

                    if (data.state === 'PENDING' || data.state === 'PROGRESS') {
                        statusMessageEl.textContent = data.status || '[V2] AI가 기획안을 생성 중입니다...';
                        setTimeout(() => checkTaskStatus(taskId), 2000);
                    } else if (data.state === 'SUCCESS') {
                        statusMessageEl.textContent = '기획안 생성 완료! 결과 페이지로 이동합니다.';
                        window.location.href = data.result_url;
                    } else if (data.state === 'FAILURE') {
                        statusMessageEl.textContent = '오류 발생';
                        errorMessageEl.textContent = data.status || '알 수 없는 오류가 발생했습니다.';
                    }
                })
                .catch(err => {
                    const statusMessageEl = document.getElementById('status-message');
                    const errorMessageEl = document.getElementById('error-message');
                    statusMessageEl.textContent = '연결 오류';
                    errorMessageEl.textContent = '서버와의 연결이 끊어졌습니다. 페이지를 새로고침하고 다시 시도해주세요.';
                    console.error('Polling error:', err);
                });
        }

        if (task_id) {
            checkTaskStatus(task_id);
        }
    </script>
</body>
</html>