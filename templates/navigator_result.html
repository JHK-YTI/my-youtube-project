<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI 내비게이터 기획안</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; }
        .sequel-topic-form button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #f0f3ff;
            border-radius: 0.5rem;
            color: #4338ca;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .sequel-topic-form button:hover {
            background-color: #e0e7ff;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-800">AI 내비게이터 기획안</h1>
            <p class="mt-2 text-lg text-gray-600">주제: <span class="font-semibold text-indigo-600">"{{ topic }}"</span></p>
        </div>

        {% if error %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-md" role="alert">
                <p class="font-bold text-lg">오류 발생</p>
                <p class="mt-2">{{ error }}</p>
            </div>
        {% else %}
            <div class="bg-white p-8 rounded-2xl shadow-lg space-y-8">
                
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4"><i class="fas fa-bullseye text-red-500 mr-3"></i>영상 제목 제안</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <pre class="whitespace-pre-wrap text-base font-medium">{{ plan_data.titles or '제목 제안이 없습니다.' }}</pre>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4"><i class="fas fa-file-alt text-blue-500 mr-3"></i>30초 완성 대본</h2>
                    <div class="p-6 bg-gray-50 rounded-lg">
                        <pre id="final-script" class="whitespace-pre-wrap text-base leading-relaxed">{{ plan_data.script or '대본이 없습니다.' }}</pre>
                    </div>
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <form action="{{ url_for('generate_tts') }}" method="POST" target="_blank">
                            <input type="hidden" name="script" value="{{ plan_data.script or '' }}">
                            <button type="submit" class="w-full py-3 px-4 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg transition-colors flex items-center justify-center">
                                <i class="fas fa-microphone-alt mr-2"></i> AI 성우 더빙하기
                            </button>
                        </form>
                         <form action="{{ url_for('performance_predictor') }}" method="POST" target="_blank">
                            <input type="hidden" name="script" value="{{ plan_data.script or '' }}">
                            <button type="submit" class="w-full py-3 px-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition-colors flex items-center justify-center">
                                <i class="fas fa-chart-line mr-2"></i> 성공 가능성 예측하기
                            </button>
                        </form>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4"><i class="fas fa-film text-purple-500 mr-3"></i>장면별 제작 가이드 (콘티)</h2>
                    <div class="space-y-4">
                        {% if plan_data.storyboard %}
                            {% for scene in plan_data.storyboard %}
                                <div class="p-5 bg-gray-50 rounded-lg border">
                                    <h4 class="font-bold text-lg text-gray-700">{{ scene.timeline }}</h4>
                                    <p class="mt-2 text-gray-800 whitespace-pre-wrap">{{ scene.prompt }}</p>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-center text-gray-500 py-4">표시할 장면별 제작 가이드가 없습니다.</p>
                        {% endif %}
                    </div>
                </div>
                <div>
                     <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-3"></i>다음 영상 기획하기</h2>
                     <div class="p-6 bg-gray-50 rounded-lg">
                        <p class="text-center text-gray-700">현재 기획서를 바탕으로 채널의 연속성을 유지할 수 있는 다음 영상 주제를 추천받아 보세요.</p>
                        <form id="sequel-form" action="{{ url_for('get_sequel_topics') }}" method="POST" class="mt-4 text-center">
                           <input type="hidden" name="current_topic" value="{{ topic }}">
                           <button type="submit" class="py-3 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-colors">
                               <i class="fas fa-seedling mr-2"></i>이 영상의 후속편 주제 추천받기
                           </button>
                       </form>
                       <div id="sequel-topics-result" class="mt-6 text-left"></div>
                    </div>
                </div>

            </div>
        {% endif %}
        
        <div class="text-center mt-12">
            <a href="{{ url_for('navigator') }}" class="text-gray-600 hover:text-gray-800 font-semibold">
                <i class="fas fa-arrow-left mr-2"></i> 다른 주제로 다시 시작하기
            </a>
        </div>
    </div>

    <script>
        document.getElementById('sequel-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const form = this;
            const button = form.querySelector('button');
            const resultContainer = document.getElementById('sequel-topics-result');
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>추천을 생성하는 중...';
            resultContainer.innerHTML = '';

            fetch(form.action, {
                method: 'POST',
                body: new FormData(form)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultContainer.innerHTML = `<p class="text-red-500 text-center">${data.error}</p>`;
                } else if (data.sequel_topics && data.sequel_topics.length > 0) {
                    // ▼▼▼▼▼ [핵심 수정] ▼▼▼▼▼
                    let listHtml = '<h4 class="font-bold text-lg mb-3 text-gray-800">✨ 추천 후속편 주제:</h4><div class="space-y-2">';
                    data.sequel_topics.forEach(topic => {
                        // 각 주제를 form으로 감싸서 버튼으로 만듭니다.
                        listHtml += `
                            <form class="sequel-topic-form" action="{{ url_for('generate_script_from_topic') }}" method="POST" target="_blank">
                                <input type="hidden" name="topic" value="${topic}">
                                <button type="submit">
                                    <i class="fas fa-arrow-right-circle mr-2"></i>${topic}
                                </button>
                            </form>
                        `;
                    });
                    listHtml += '</div>';
                    resultContainer.innerHTML = listHtml;
                    // ▲▲▲▲▲ [핵심 수정] ▲▲▲▲▲
                } else {
                    resultContainer.innerHTML = '<p class="text-gray-500 text-center">추천할 후속편 주제가 없습니다.</p>';
                }
            })
            .catch(error => {
                resultContainer.innerHTML = `<p class="text-red-500 text-center">오류가 발생했습니다: ${error}</p>`;
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-seedling mr-2"></i>이 영상의 후속편 주제 추천받기';
            });
        });
    </script>

</body>
</html>