<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>디버깅 중...</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #007bff; animation: spin 1s ease infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-message { margin-top: 20px; font-size: 16px; color: #6c757d; }
        #debug-output { text-align: left; margin: 50px auto; padding: 20px; border: 1px solid #ccc; background-color: #f9f9f9; width: 80%; max-height: 400px; overflow-y: scroll; }
    </style>
</head>
<body>
    <div class="spinner"></div>
    <p id="status-message">데이터 수신 중... (디버깅 모드)</p>
    <div id="debug-output">
        <h3>디버그 로그:</h3>
    </div>

    <script>
        const job_id = "{{ job_id }}";
        const source = new EventSource(`/extract_stream/${job_id}`);
        const statusMessage = document.getElementById('status-message');
        const debugOutput = document.getElementById('debug-output');

        function appendLog(message) {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugOutput.appendChild(p);
            debugOutput.scrollTop = debugOutput.scrollHeight; // 자동 스크롤
        }

        appendLog("디버깅 시작...");
        appendLog(`Job ID: ${job_id}`);
        appendLog("SSE 스트림 연결 시도 중...");

        source.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                const type = data.type;
                const payload = data.data;

                appendLog(`수신됨 - Type: ${type}`);

                if (type === 'status') {
                    statusMessage.textContent = data.message;
                    appendLog(`Status: ${data.message}`);
                } 
                else if (type === 'metadata') {
                    appendLog(`메타데이터 수신됨: 제목 - ${payload.title}, ID - ${payload.video_id}`);
                    statusMessage.textContent = '영상 정보 수신 완료!';
                }
                else if (type === 'transcript') {
                    appendLog(`원본 대본 수신됨 (길이: ${payload.text.length})`);
                    statusMessage.textContent = '원본 대본 추출 완료!';
                }
                else if (type === 'correction') {
                    appendLog(`교정된 대본 수신됨 (길이: ${payload.text.length})`);
                    statusMessage.textContent = '대본 교정 완료!';
                }
                else if (type === 'analysis') {
                    appendLog(`AI 분석 요약 내용 수신됨 (payload.summary): ${payload.summary}`); // 이 로그가 핵심!
                    document.getElementById('debug-output').innerHTML += `<p><strong>수신된 AI 분석 내용:</strong></p><pre>${payload.summary}</pre>`;
                    statusMessage.textContent = 'AI 분석 완료!';
                }
                else if (type === 'done') {
                    appendLog("모든 작업 완료 신호 수신됨.");
                    statusMessage.textContent = '분석 완료!';
                    source.close();
                    appendLog("SSE 스트림 종료.");
                    // 각색 버튼 테스트를 위해 여기에 간단한 버튼을 추가할 수 있습니다.
                    // alert("디버깅 완료. 콘솔과 디버그 로그를 확인하세요.");
                }
                else if (type === 'error') {
                    appendLog(`오류 수신됨: ${data.message}`);
                    statusMessage.textContent = `오류: ${data.message}`;
                    source.close();
                }
            } catch (e) {
                appendLog(`JSON 파싱 오류 또는 이벤트 처리 오류: ${e.message}. 원본 데이터: ${event.data}`);
            }
        };

        source.onerror = function(err) {
            appendLog(`SSE 연결 오류: ${err.message || err}. 연결을 확인하세요.`);
            statusMessage.textContent = '스트림 연결 오류 발생!';
            source.close();
        };

    </script>
</body>
</html>